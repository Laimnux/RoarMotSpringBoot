<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completar Perfil | MYMOTO</title>
    <!-- Incluye Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente personalizada de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        /* Clase para usar la fuente Bebas Neue */
        .font-bebas { font-family: 'Bebas Neue', sans-serif; }
        /* Color de fondo personalizado */
        .bg-cream { background-color: #FBF9F7; }
        
        /* Estilos para los inputs cuando tienen focus */
        .peer:focus {
            border-color: #fd8c00 !important; /* Color naranja del borde al enfocar */
        }
        .peer-focus:text-[#fd8c00] { /* Color del label al enfocar */
            color: #fd8c00 !important;
        }

        /* Estilos para inputs válidos e inválidos */
        .form-input.valid { border-color: #22c55e !important; } /* verde */
        .form-input.invalid { border-color: #ef4444 !important; } /* rojo */

        /* Estilos para los labels cuando el input es válido/inválido */
        .form-input.valid ~ label { color: #22c55e !important; }
        .form-input.invalid ~ label { color: #ef4444 !important; }
        
        /* Estilo para los mensajes de error */
        .error-message { 
            color: #ef4444; /* rojo */
            font-size: 0.75rem; /* pequeño */
            margin-top: 0.25rem; 
        }
        
        /* Animación de shake para inputs inválidos */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.5s; }
        
        /* Estilos para la barra de fortaleza de contraseña */
        #password-strength-bar {
            height: 6px;
            width: 100%;
            background-color: #e2e8f0; /* gris claro */
            border-radius: 9999px; /* completamente redondeado */
            overflow: hidden;
            margin-top: 0.5rem;
            display: flex; /* los segmentos se alinean en línea */
        }
        #password-strength-bar span {
            flex-grow: 1; /* los segmentos ocupan espacio igual */
            transition: background-color 0.3s ease-in-out;
            height: 100%;
        }

        /* Estilo para el botón cuando está deshabilitado */
        #submit-btn:disabled {
            background-color: #a0aec0 !important; /* gris */
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
            opacity: 0.7; /* semi-transparente */
        }

        /* Estilo para el icono de mostrar/ocultar contraseña */
        .password-toggle-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af; /* gris */
            z-index: 10; /* sobre el input */
        }
        .password-toggle-icon svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body class="bg-cream min-h-screen flex relative">

    <!-- Alerta flotante para mostrar mensajes al usuario -->
    <div id="alerta" class="hidden fixed top-6 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-lg shadow-lg text-white font-semibold text-center max-w-md w-full">
        <span id="mensaje-alerta"></span>
    </div>

    <!-- Contenedor del formulario -->
    <div class="w-full lg:w-1/2 flex items-center justify-center p-8">
        <div class="max-w-md w-full">
            
            <!-- Logo de la aplicación -->
            <div class="bg-white p-4 rounded-xl shadow-sm mb-10">
                <div class="flex items-center justify-center space-x-1">
                    <img src="/imagenes/Logo-RoarMot-Negro.png" alt="Logo MYMOTO" class="h-16 w-auto object-contain">
                    <img src="/imagenes/tipografia-roarmot-negro.png" alt="Texto MYMOTO" class="h-10 w-auto object-contain">
                </div>
            </div>

            <!-- Formulario principal -->
            <div class="bg-white p-10 rounded-xl shadow-sm">
                <h1 class="font-bebas text-4xl text-gray-800 text-center mb-2">COMPLETA TU PERFIL</h1>
                <p class="text-gray-600 text-center mb-8">Último paso para unirte a la comunidad</p>
                
                <!-- Formulario con todos los campos -->
                <form class="mt-8 space-y-6" id="formularioPaso3" th:action="@{/guardar-usuario}" method="post">

                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <!-- Campo oculto para el email obtenido de la URL -->
                    <input type="hidden" id="email" name="email" th:value="${usuario.email}">

                    <input type="hidden" id="rol" name="rol" th:value="${rol}">

                    <div class="space-y-6">
                        <!-- Grupo de campos nombre y apellido -->
                        <div class="flex flex-col md:flex-row gap-4">
                            <!-- Campo nombre -->
                            <div class="relative flex-1">
                                <input 
                                    type="text" 
                                    id="nombre" 
                                    name="nombre"
                                    required 
                                    maxlength="30"
                                    pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+"
                                    data-error-msg="Solo se permiten letras (máx. 30)."
                                    class="form-input peer w-full px-3 border rounded-md bg-transparent
                                            border-gray-300 focus:outline-none"
                                    placeholder=" "
                                    style="padding-top: 1rem; padding-bottom: 0.85rem;"
                                />
                                <!-- Label flotante para el input -->
                                <label 
                                    for="nombre"
                                    class="absolute left-3 bg-white px-1
                                        transition-all duration-200 pointer-events-none
                                        text-[#fd8c00]  /* Color por defecto cuando está arriba (lleno) */
                                        top-[-0.5rem]   /* [ESTADO 1: Arriba por defecto] Posición superior */
                                        text-xs        /* [ESTADO 1: Arriba por defecto] Tamaño de texto pequeño */
                                        
                                        /* [ESTADO 2: Vacío/No enfocado] Vuelve al centro */
                                        peer-placeholder-shown:top-[1.1rem]
                                        peer-placeholder-shown:-translate-y-0
                                        peer-placeholder-shown:text-base
                                        peer-placeholder-shown:text-gray-500
                                        
                                        /* [ESTADO 3: Enfocado] Solo cambia el color para indicar foco */
                                        peer-focus:text-[#fd8c00] peer-focus:text-xs" 
                                >
                                    Nombre
                                </label>
                                <!-- Contenedor para mensaje de error -->
                                <div class="error-message hidden"></div>
                            </div>

                            <!-- Campo apellido (similar al nombre) -->
                            <div class="relative flex-1">
                                <input 
                                    type="text" 
                                    id="apellido" 
                                    name="apellido"
                                    required 
                                    maxlength="30"
                                    pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+"
                                    data-error-msg="Solo se permiten letras (máx. 30)."
                                    class="form-input peer w-full px-3 border rounded-md bg-transparent
                                            border-gray-300 focus:outline-none"
                                    placeholder=" "
                                    style="padding-top: 1rem; padding-bottom: 0.85rem;"
                                >
                                <label 
                                    for="apellido"
                                    class="absolute left-3 bg-white px-1
                                        transition-all duration-200 pointer-events-none
                                        
                                        /* CLASES BASE (ESTADO: LLENO) */
                                        text-[#fd8c00]   /* Color de la línea de texto cuando está arriba (lleno/enfocado) */
                                        top-[-0.5rem]    /* Posición superior (flotante) por defecto */
                                        text-xs          /* Tamaño de texto pequeño por defecto */
                                        
                                        /* ANULACIÓN (ESTADO: VACÍO) */
                                        peer-placeholder-shown:top-[1.1rem] 
                                        peer-placeholder-shown:-translate-y-0
                                        peer-placeholder-shown:text-base
                                        peer-placeholder-shown:text-gray-500
                                        
                                        /* FOCO (Solo ajusta el color o estilo si es necesario, la posición ya está definida) */
                                        peer-focus:text-[#fd8c00] peer-focus:text-xs" 
                                >
                                    Apellido
                                </label>
                                <div class="error-message hidden"></div>
                            </div>
                        </div>

                        <!-- Campo teléfono -->
                        <div class="relative">
                            <input 
                                type="tel" 
                                id="telefono" 
                                name="telefono"
                                required 
                                maxlength="10"
                                pattern="\d{10}"
                                data-error-msg="Ingresa un teléfono válido (10 dígitos)."
                                class="form-input peer w-full px-3 border rounded-md bg-transparent
                                        border-gray-300 focus:outline-none"
                                placeholder=" "
                                style="padding-top: 1rem; padding-bottom: 0.85rem;"
                            >
                           <label 
                                for="telefono"
                                class="absolute left-3 bg-white px-1
                                    transition-all duration-200 pointer-events-none
                                    
                                    /* CLASES BASE (ESTADO: LLENO Y ENFOCADO) */
                                    text-[#fd8c00]   /* Color de la línea de texto cuando está arriba (lleno/enfocado) */
                                    top-[-0.5rem]    /* Posición superior (flotante) por defecto */
                                    text-xs          /* Tamaño de texto pequeño por defecto */
                                    
                                    /* ANULACIÓN (ESTADO: VACÍO) */
                                    peer-placeholder-shown:top-[1.1rem] 
                                    peer-placeholder-shown:-translate-y-0
                                    peer-placeholder-shown:text-base
                                    peer-placeholder-shown:text-gray-500
                                    
                                    /* FOCO (Solo ajusta el color, la posición ya está definida) */
                                    peer-focus:text-[#fd8c00] peer-focus:text-xs" 
                            >
                                Teléfono
                            </label>
                            <div class="error-message hidden"></div>
                        </div>
                        <!-- Campo Nombre Empresa con toggle de visibilidad solo si es vendedor -->
                        <div id="campo-nombre-empresa" th:if="${rol == 'vendedor'}" class="relative">
    
                            <input 
                                type="text" 
                                id="nombreEmpresa" 
                                name="nombreEmpresa"
                                maxlength="50"
                                class="form-input peer w-full px-3 border rounded-md bg-transparent border-gray-300 focus:outline-none"
                                placeholder=" "
                                style="padding-top: 1rem; padding-bottom: 0.85rem;"
                            />
                            <label 
                                for="nombreEmpresa"
                                class="absolute left-3 bg-white px-1 transition-all duration-200 pointer-events-none text-[#fd8c00] top-[-0.5rem] text-xs peer-placeholder-shown:top-[1.1rem] peer-placeholder-shown:-translate-y-0 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-focus:text-[#fd8c00] peer-focus:text-xs" 
                            >
                                Nombre de la Empresa (Opcional)
                            </label>
                            <div class="error-message hidden"></div>
                        </div>

                        <!-- Campo contraseña con toggle de visibilidad -->
                        <div class="relative">
                            <input 
                                type="password" 
                                id="password" 
                                name="password"
                                required 
                                minlength="8"
                                class="form-input peer w-full px-3 border rounded-md bg-transparent
                                        border-gray-300 focus:outline-none pr-10"
                                placeholder=" "
                                style="padding-top: 1rem; padding-bottom: 0.85rem;"
                            >
                            <label 
                                for="password"
                                class="absolute left-3 bg-white px-1
                                    transition-all duration-200 pointer-events-none
                                    
                                    /* CLASES BASE (ESTADO: LLENO Y ENFOCADO) */
                                    text-[#fd8c00]   /* Color de la línea de texto cuando está arriba (lleno/enfocado) */
                                    top-[-0.5rem]    /* Posición superior (flotante) por defecto */
                                    text-xs          /* Tamaño de texto pequeño por defecto */
                                    
                                    /* ANULACIÓN (ESTADO: VACÍO) */
                                    peer-placeholder-shown:top-[1.1rem] 
                                    peer-placeholder-shown:-translate-y-0
                                    peer-placeholder-shown:text-base
                                    peer-placeholder-shown:text-gray-500
                                    
                                    /* FOCO (Solo ajusta el color, la posición ya está definida) */
                                    peer-focus:text-[#fd8c00] peer-focus:text-xs" 
                            >
                                Contraseña (mínimo 8 caracteres)
                            </label>
                            <!-- Icono para mostrar/ocultar contraseña -->
                            <span class="password-toggle-icon" onclick="togglePasswordVisibility('password')">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path id="password-icon-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path id="password-icon-path2" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </span>
                            <div class="error-message hidden"></div>
                            
                            <!-- Barra de fortaleza de contraseña -->
                            <div id="password-strength-bar" class="w-full mt-2 hidden">
                                <span id="strength-segment-1" class="rounded-l-full"></span>
                                <span id="strength-segment-2"></span>
                                <span id="strength-segment-3" class="rounded-r-full"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Checkbox de términos y condiciones -->
                    <div class="flex items-start mt-4">
                        <div class="flex items-center h-5">
                            <input 
                                id="terminos" 
                                name="terminos" 
                                type="checkbox" 
                                required
                                class="focus:ring-[#fd8c00] h-4 w-4 text-[#fd8c00] border-gray-300 rounded"
                            >
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="terminos" class="font-medium text-gray-700">
                                Acepto los <a href="#" class="text-[#fd8c00] hover:text-[#e67e00]">términos y condiciones</a>
                            </label>
                            <div id="terminos-error" class="error-message hidden mt-1">Debes aceptar los términos y condiciones</div>
                        </div>
                    </div>

                    <!-- Botón de submit -->
                    <button 
                        type="submit" 
                        id="submit-btn"
                        disabled 
                        class="w-full bg-gray-400 text-white ..."
                    >
                        COMPLETAR REGISTRO
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel derecho con imagen (solo visible en pantallas grandes) -->
    <div class="hidden lg:block w-1/2 relative p-2">
        <div class="relative w-full h-full rounded-xl overflow-hidden shadow-lg">
            <!-- Imagen que cambia según el rol del usuario -->
            <img id="perfil-image" src="/imagenes/Motero.jpg" alt="Moto MYMOTO" 
                 class="absolute h-full w-auto max-w-none transition-all duration-300">
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. OBTENER DATOS DE CAMPOS OCULTOS y CONFIGURAR IMAGEN DE PERFIL ---
        const email = document.getElementById('email').value;
        const rol = document.getElementById('rol').value;
        
        const perfilImage = document.getElementById('perfil-image');
        if (perfilImage) {
            perfilImage.classList.remove('left-[-15%]', 'right-[-40%]');
            if (rol === 'vendedor') {
                perfilImage.src = '/imagenes/proveedor.jpg';
                perfilImage.alt = 'Proveedor MYMOTO';
                perfilImage.classList.add('right-[-40%]');
            } else { 
                perfilImage.src = '/imagenes/Motero.jpg';
                perfilImage.alt = 'Moto MYMOTO';
                perfilImage.classList.add('left-[-15%]');
            }
        }

        // --- 2. OBTENER ELEMENTOS DEL FORMULARIO ---
        const formulario = document.getElementById('formularioPaso3');
        const inputsToValidate = document.querySelectorAll('.form-input');
        const passwordInput = document.getElementById('password');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const strengthSegments = [
            document.getElementById('strength-segment-1'),
            document.getElementById('strength-segment-2'),
            document.getElementById('strength-segment-3')
        ];
        const terminosCheckbox = document.getElementById('terminos');
        const terminosError = document.getElementById('terminos-error');
        const submitBtn = document.getElementById('submit-btn');

        // --- 3. FUNCIÓN PARA VERIFICAR VALIDEZ DEL FORMULARIO COMPLETO ---
        function checkFormValidity() {
            let formIsValid = true;
            
            inputsToValidate.forEach(input => {
                if (!input.checkValidity() || input.value.trim() === '') {
                    formIsValid = false;
                }
            });
            
            if (passwordInput.value.trim() !== '') {
                if (!checkPasswordStrength(false)) {
                    formIsValid = false;
                }
            }
            
            if (!terminosCheckbox.checked) {
                formIsValid = false;
            }
            
            if (formIsValid) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400');
                submitBtn.classList.add('bg-red-600', 'hover:bg-[#fd8c00]', 'hover:scale-[1.02]', 'hover:shadow-xl');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-red-600', 'hover:bg-[#fd8c00]', 'hover:scale-[1.02]', 'hover:shadow-xl');
                submitBtn.classList.add('bg-gray-400');
            }
        }

        // --- 4. VALIDACIÓN Y ESTILOS PARA CADA INPUT ---
        function validateAndStyleInput(input) {
            const value = input.value.trim();
            const parentDiv = input.closest('.relative');
            const errorMessageDiv = parentDiv.querySelector('.error-message');
            const label = parentDiv.querySelector('label');
            
            let isValid = input.checkValidity();
            
            input.classList.remove('valid', 'invalid', 'shake', 'border-gray-300', 'border-red-500', 'border-green-500', 'border-[#fd8c00]');
            label.classList.remove('text-red-500', 'text-green-500', 'text-gray-500', 'text-[#fd8c00]');

            if (input.id === 'password' && value.length > 0) {
                if (!checkPasswordStrength(true)) {
                    isValid = false;
                }
            }
            
            if (value === '') {
                input.classList.add('border-gray-300');
                label.classList.add('text-gray-500');
                errorMessageDiv.classList.add('hidden');
            } else if (isValid) {
                input.classList.add('valid', 'border-green-500');
                label.classList.add('text-green-500');
                errorMessageDiv.classList.add('hidden');
            } else {
                input.classList.add('invalid', 'shake', 'border-red-500');
                label.classList.add('text-red-500');
                errorMessageDiv.textContent = input.dataset.errorMsg || 'Campo inválido.';
                if (input.id === 'password') {
                    checkPasswordStrength(true);
                }
                errorMessageDiv.classList.remove('hidden');
            }
            
            checkFormValidity();
        }

        // --- 5. VERIFICAR FORTALEZA DE CONTRASEÑA ---
        function checkPasswordStrength(showAlerts = true) {
            const password = passwordInput.value;
            const errorMessageDiv = passwordInput.closest('.relative').querySelector('.error-message');
            let strength = 0;
            let missingRequirements = [];
            let isValidPassword = true;

            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            const isMinLength = password.length >= 8;

            if (!isMinLength) {
                missingRequirements.push('al menos 8 caracteres');
                isValidPassword = false;
            } else {
                if (hasUppercase) strength++; else missingRequirements.push('una mayúscula');
                if (hasLowercase) strength++; else missingRequirements.push('una minúscula');
                if (hasNumber) strength++; else missingRequirements.push('un número');
                if (hasSpecialChar) strength++; else missingRequirements.push('un carácter especial');
            }
            
            if (showAlerts) {
                if (missingRequirements.length > 0) {
                    errorMessageDiv.textContent = `La contraseña debe contener: ${missingRequirements.join(', ')}.`;
                    errorMessageDiv.classList.remove('hidden');
                } else {
                    errorMessageDiv.classList.add('hidden');
                }
            }

            strengthSegments.forEach((segment, index) => {
                segment.className = ''; 
                if (index < strength) {
                    if (strength <= 2) {
                        segment.classList.add('bg-red-500');
                    } else if (strength === 3) {
                        segment.classList.add('bg-orange-400');
                    } else if (strength === 4) {
                        segment.classList.add('bg-green-500');
                    }
                } else {
                    segment.classList.add('bg-gray-200');
                }
                if (index === 0) segment.classList.add('rounded-l-full');
                if (index === 2) segment.classList.add('rounded-r-full');
            });
            
            return isValidPassword;
        }

        // 6. TOGGLE VISIBILIDAD DE CONTRASEÑA ---
        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            const iconPath = document.getElementById(`${id}-icon-path`);
            const iconPath2 = document.getElementById(`${id}-icon-path2`);

            if (input.type === 'password') {
                input.type = 'text';
                iconPath.setAttribute('d', 'M13.879 13.879a3 3 0 11-4.242-4.242M10.121 10.121a3 3 0 104.242 4.242');
                iconPath2.setAttribute('d', 'M1.96 12C2.923 7.953 6.666 5 12 5c4.954 0 8.358 2.943 9.439 7-1.081 4.057-4.485 7-9.439 7-5.334 0-9.077-2.953-10.04-7z');
            } else {
                input.type = 'password';
                iconPath.setAttribute('d', 'M15 12a3 3 0 11-6 0 3 3 0 016 0z');
                iconPath2.setAttribute('d', 'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z');
            }
        }
        window.togglePasswordVisibility = togglePasswordVisibility;

        // 7. EVENT LISTENERS ---
        inputsToValidate.forEach(input => {
            input.addEventListener('input', () => {
                validateAndStyleInput(input);
            });
            
            input.addEventListener('blur', () => {
                validateAndStyleInput(input);
            });
            
            input.addEventListener('focus', () => {
                input.classList.remove('valid', 'invalid', 'border-gray-300', 'border-red-500', 'border-green-500');
                input.classList.add('border-[#fd8c00]');
                const label = input.closest('.relative').querySelector('label');
                label.classList.remove('text-red-500', 'text-green-500', 'text-gray-500');
                label.classList.add('text-[#fd8c00]');
                input.closest('.relative').querySelector('.error-message').classList.add('hidden');
                
                if (input.id === 'password' && input.value.trim() !== '') {
                    passwordStrengthBar.classList.remove('hidden');
                } else if (input.id === 'password') {
                    passwordStrengthBar.classList.add('hidden');
                }
            });
        });

        terminosCheckbox.addEventListener('change', function() {
            if (this.checked) {
                terminosError.classList.add('hidden');
            } else {
                terminosError.classList.remove('hidden');
            }
            checkFormValidity();
        });

        // 8. MANEJO DEL ENVÍO DEL FORMULARIO ---
        formulario.addEventListener('submit', function(e) {
            checkFormValidity();
            if (submitBtn.disabled) {
                e.preventDefault(); 
                const alerta = document.getElementById('alerta');
                const mensaje = document.getElementById('mensaje-alerta');
                if (alerta && mensaje) {
                    mensaje.textContent = 'Por favor, completa todos los campos correctamente y acepta los términos.';
                    alerta.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 z-50 px-6 py-4 rounded-lg shadow-lg text-white font-semibold text-center max-w-md w-full bg-red-600';
                    alerta.classList.remove('hidden');
                    setTimeout(() => { alerta.classList.add('hidden'); }, 3000);
                }
            }
        });

        // 9. INICIALIZACIÓN ---
        checkFormValidity();
    });
</script>
</body>
</html>