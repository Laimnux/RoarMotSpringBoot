<div th:fragment="scripts">
    <!-- Reemplaza el kit de FontAwesome con CDN p煤blico -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
            // =========================================================
            // CONFIGURACIN INICIAL
            // =========================================================
            let currentMotoData = null;
            
            // RUTA DE IMAGEN POR DEFECTO - AJUSTA SEGN TU PROYECTO
            const DEFAULT_IMAGE_PATH = 'https://placehold.co/600x400?text=Moto+Sin+Imagen';
            
            // =========================================================
            //  FUNCIN PRINCIPAL: VERIFICAR SI HAY MOTO REGISTRADA
            // =========================================================
            function verificarYMostrarMotoRegistrada() {
            console.log('=== VERIFICANDO MOTO ===');
            
            // Usa las variables GLOBALES
            const motoDesdeBackend = window.motoDelUsuarioBackend || null;
            const usuarioId = window.usuarioIdBackend || null;
            
            console.log('DATOS DESDE FRAGMENTO:');
            console.log('  - usuarioId:', usuarioId);
            console.log('  - motoDesdeBackend:', motoDesdeBackend);
            
            // RESTAURAR localStorage (si quieres usarlo)
            // localStorage.removeItem('motoUsuario'); // Descomenta si quieres limpiar
            
            // L贸gica para mostrar
            if (motoDesdeBackend && motoDesdeBackend.placaMoto) {
                console.log('Mostrando moto del backend:', motoDesdeBackend.placaMoto);
                currentMotoData = motoDesdeBackend;
                mostrarVistaDetalle(motoDesdeBackend);
                return true;
            }
            
            console.log('Mostrando formulario vac铆o');
            mostrarVistaRegistro();
            return false;
        }

        // Tambi茅n COMENTA esta funci贸n:
        function guardarEnLocalStorage(datosMoto) {
            // TEMPORALMENTE NO GUARDAR
            // localStorage.setItem('motoUsuario', JSON.stringify(datosMoto));
            console.log('锔 localStorage deshabilitado temporalmente');
        }

        // =========================================================
        //  FUNCIONES DE PERSISTENCIA
        // =========================================================
        function guardarEnLocalStorage(datosMoto) {
            try {
                localStorage.setItem('motoUsuario', JSON.stringify(datosMoto));
                console.log('Datos guardados en localStorage');
            } catch (e) {
                console.error('Error guardando en localStorage:', e);
            }
        }

        function limpiarLocalStorage() {
            localStorage.removeItem('motoUsuario');
            sessionStorage.removeItem('imagenMotoSubida');
            console.log('localStorage limpiado');
        }

        // =========================================================
        // FUNCIONES DE VISUALIZACIN
        // =========================================================
        function mostrarVistaDetalle(datosMoto) {
            console.log('Mostrando vista de detalle');
            
            // Ocultar formulario de registro
            const registroDiv = document.getElementById('moto-manager__registro');
            if (registroDiv) {
                registroDiv.classList.remove('active');
                registroDiv.classList.add('hidden');
            }
            
            // Mostrar vista de detalle
            const detalleDiv = document.getElementById('moto-manager__detalle');
            if (detalleDiv) {
                detalleDiv.classList.remove('hidden');
                detalleDiv.classList.add('active');
                
                // Llenar todos los campos con los datos
                if (datosMoto.placaMoto) document.getElementById('detalle-placa').textContent = datosMoto.placaMoto;
                if (datosMoto.marcaMoto) document.getElementById('detalle-marca').textContent = datosMoto.marcaMoto;
                if (datosMoto.modeloMoto) document.getElementById('detalle-modelo').textContent = datosMoto.modeloMoto;
                if (datosMoto.colorMoto) document.getElementById('detalle-color').textContent = datosMoto.colorMoto;
                if (datosMoto.kilometraje) document.getElementById('detalle-kilometraje').textContent = datosMoto.kilometraje.toLocaleString() + ' km';
                if (datosMoto.tecnomecanica) document.getElementById('detalle-tecnomecanica').textContent = datosMoto.tecnomecanica;
                if (datosMoto.soatMoto) document.getElementById('detalle-soat').textContent = datosMoto.soatMoto;
                
                // Manejar la imagen CON FALLBACK
                const detalleImagen = document.getElementById('detalle-imagen');
                if (detalleImagen) {
                    let imagenUrl = datosMoto.imagenMoto;
                    
                    // Si no hay imagen, usar placeholder
                    if (!imagenUrl || imagenUrl === '' || imagenUrl === 'moto-default.jpg') {
                        imagenUrl = DEFAULT_IMAGE_PATH;
                    }
                    // Si es una ruta relativa sin /, agregar /img/
                    else if (!imagenUrl.startsWith('http') && !imagenUrl.startsWith('/') && !imagenUrl.startsWith('data:')) {
                        imagenUrl = '/img/' + imagenUrl;
                    }
                    
                    // Configurar imagen
                    detalleImagen.src = imagenUrl;
                    
                    // Si falla la carga, usar placeholder
                    detalleImagen.onerror = function() {
                        console.warn('Imagen no encontrada, usando placeholder:', imagenUrl);
                        this.src = DEFAULT_IMAGE_PATH;
                        this.onerror = null; // Prevenir loop infinito
                    };
                }
            }
        }

        function mostrarVistaRegistro() {
            console.log('Mostrando vista de registro');
            
            // Mostrar formulario de registro
            const registroDiv = document.getElementById('moto-manager__registro');
            if (registroDiv) {
                registroDiv.classList.remove('hidden');
                registroDiv.classList.add('active');
            }
            
            // Ocultar vista de detalle
            const detalleDiv = document.getElementById('moto-manager__detalle');
            if (detalleDiv) {
                detalleDiv.classList.remove('active');
                detalleDiv.classList.add('hidden');
            }
            
            // Si estamos en modo nuevo (no edici贸n), limpiar formulario
            if (!currentMotoData) {
                limpiarFormulario();
            }
        }

        function limpiarFormulario() {
            const form = document.getElementById('motoForm');
            if (form) {
                form.reset();
                
                // Restaurar placeholder de imagen
                const imageDisplay = document.getElementById('moto-image-display');
                if (imageDisplay) {
                    imageDisplay.innerHTML = `
                        <i class="fas fa-motorcycle text-4xl mb-2 text-gray-400"></i>
                        <p class="text-sm font-bold">Subir foto de tu moto</p>
                        <p class="text-xs text-gray-400">Clic para seleccionar</p>
                    `;
                }
                
                console.log('Formulario limpiado');
            }
        }

        function precargarFormularioEdicion() {
            if (!currentMotoData) {
                console.log('No hay datos para precargar');
                return;
            }
            
            console.log('Precargando datos para edici贸n');
            
            // Llenar campos del formulario con datos existentes
            document.getElementById('marca').value = currentMotoData.marcaMoto || '';
            document.getElementById('modelo').value = currentMotoData.modeloMoto || '';
            document.getElementById('color').value = currentMotoData.colorMoto || '';
            document.getElementById('placa').value = currentMotoData.placaMoto || '';
            document.getElementById('kilometraje').value = currentMotoData.kilometraje || 0;
            document.getElementById('soat').value = currentMotoData.soatMoto || '';
            document.getElementById('tecnomecanica').value = currentMotoData.tecnomecanica || '';
            
            // Precargar imagen si existe
            const imageDisplay = document.getElementById('moto-image-display');
            if (imageDisplay && currentMotoData.imagenMoto) {
                let imgUrl = currentMotoData.imagenMoto;
                
                // Asegurar ruta correcta
                if (imgUrl && !imgUrl.startsWith('http') && !imgUrl.startsWith('/') && !imgUrl.startsWith('data:')) {
                    imgUrl = '/img/' + imgUrl;
                }
                
                if (imgUrl && imgUrl !== 'moto-default.jpg') {
                    imageDisplay.innerHTML = `
                        <img src="${imgUrl}" 
                             alt="Foto de la moto" 
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null; this.parentElement.innerHTML = '<i class=\"fas fa-motorcycle text-4xl mb-2 text-gray-400\"></i><p class=\"text-sm font-bold\">Imagen no disponible</p>';">
                    `;
                }
            }
        }

        // =========================================================
        //  INICIALIZACIN AL CARGAR LA PGINA
        // =========================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P谩gina cargada. Inicializando sistema de motos...');
            
            // 1. Verificar y mostrar moto registrada
            verificarYMostrarMotoRegistrada();
            
            // 2. Configurar todos los eventos
            configurarEventListeners();
            
            // 3. Configurar arrastrar y soltar para imagen
            configurarDragAndDrop();
        });

        function configurarEventListeners() {
            // 1. Bot贸n Editar - Cambia a vista de edici贸n
            document.getElementById('btn-editar-moto')?.addEventListener('click', function() {
                console.log('Bot贸n editar clickeado - Cambiando a modo edici贸n');
                mostrarVistaRegistro();
                precargarFormularioEdicion();
            });
            
            // 2. Bot贸n Cancelar (si existe)
            document.getElementById('btn-cancelar')?.addEventListener('click', function() {
                console.log('Cancelar clickeado');
                if (currentMotoData) {
                    mostrarVistaDetalle(currentMotoData);
                } else {
                    mostrarVistaRegistro();
                    limpiarFormulario();
                }
            });
            
            // 3. Subida de imagen
            const uploadInput = document.getElementById('upload-moto-image');
            if (uploadInput) {
                uploadInput.addEventListener('change', async function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    console.log(' Imagen seleccionada:', file.name);
                    
                    // Previsualizaci贸n inmediata
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const displayArea = document.getElementById('moto-image-display');
                        if (displayArea) {
                            displayArea.innerHTML = `<img src="${e.target.result}" alt="Foto de la moto" class="w-full h-full object-cover" />`;
                            // Guardar temporalmente
                            displayArea.dataset.tempImage = e.target.result;
                        }
                    };
                    reader.readAsDataURL(file);
                    
                    // Intentar subir al backend si es necesario
                    try {
                        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                        
                        if (csrfToken && csrfHeader) {
                            const formData = new FormData();
                            formData.append('imagenMoto', file);
                            
                            const response = await fetch('/api/motos/subir-imagen', {
                                method: 'POST',
                                headers: { [csrfHeader]: csrfToken },
                                body: formData
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                sessionStorage.setItem('imagenMotoSubida', result.nombreArchivo || file.name);
                                console.log('Imagen subida al servidor');
                            }
                        }
                    } catch (error) {
                        console.log('Imagen guardada solo localmente:', error);
                        // Guardar solo en sessionStorage como fallback
                        sessionStorage.setItem('imagenTemp', file.name);
                    }
                });
            }
            
            // 4. Env铆o del formulario
            const motoForm = document.getElementById('motoForm');
            if (motoForm) {
                motoForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log(' Enviando formulario...');
                    
                    // Obtener tokens CSRF
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                    
                    // Obtener imagen subida
                    const imagenSubida = sessionStorage.getItem('imagenMotoSubida');
                    const imagenTemp = document.getElementById('moto-image-display')?.dataset.tempImage;
                    
                    // Preparar datos
                    const formData = {
                        marcaMoto: document.getElementById('marca').value,
                        modeloMoto: document.getElementById('modelo').value,
                        colorMoto: document.getElementById('color').value,
                        placaMoto: document.getElementById('placa').value,
                        kilometraje: parseInt(document.getElementById('kilometraje').value) || 0,
                        soatMoto: document.getElementById('soat').value,
                        tecnomecanica: document.getElementById('tecnomecanica').value,
                        idMoto: currentMotoData ? currentMotoData.idMoto : null,
                        imagenMoto: imagenSubida || (currentMotoData ? currentMotoData.imagenMoto : '')
                    };
                    
                    // Validaci贸n b谩sica
                    if (!formData.placaMoto || !formData.marcaMoto) {
                        alert('Por favor completa placa y marca');
                        return;
                    }
                    
                    try {
                        // Enviar al backend
                        const response = await fetch('/api/motos', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                [csrfHeader]: csrfToken 
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        if (response.ok) {
                            const resultado = await response.json();
                            console.log(' Moto guardada exitosamente');
                            
                            // Actualizar datos
                            currentMotoData = resultado;
                            
                            // Guardar en localStorage
                            guardarEnLocalStorage(resultado);
                            
                            // Limpiar almacenamiento temporal
                            sessionStorage.removeItem('imagenMotoSubida');
                            sessionStorage.removeItem('imagenTemp');
                            
                            // Mostrar vista de detalle
                            mostrarVistaDetalle(resultado);
                            
                            // Mostrar mensaje
                            alert('Moto registrada/actualizada correctamente');
                            
                        } else {
                            const error = await response.text();
                            console.error(' Error del servidor:', error);
                            alert('Error al guardar: ' + error);
                        }
                    } catch (error) {
                        console.error('Error de conexi贸n:', error);
                        alert('Error de conexi贸n con el servidor');
                    }
                });
            }
            
            // 5. Bot贸n para eliminar moto (si existe)
            document.getElementById('btn-eliminar-moto')?.addEventListener('click', function() {
                if (confirm('驴Est谩s seguro de eliminar el registro de tu moto?')) {
                    limpiarLocalStorage();
                    currentMotoData = null;
                    mostrarVistaRegistro();
                    limpiarFormulario();
                    alert('Registro eliminado');
                }
            });
        }

        function configurarDragAndDrop() {
            const dropArea = document.getElementById('moto-image-display');
            if (!dropArea) return;
            
            // Prevenir comportamientos por defecto
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Resaltar 谩rea cuando se arrastra sobre ella
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('border-blue-500', 'border-2');
            }
            
            function unhighlight() {
                dropArea.classList.remove('border-blue-500', 'border-2');
            }
            
            // Manejar archivo soltado
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // Simular cambio en el input file
                    const input = document.getElementById('upload-moto-image');
                    if (input) {
                        // Necesitamos crear un DataTransfer para asignar archivos
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(files[0]);
                        input.files = dataTransfer.files;
                        
                        // Disparar evento change
                        const event = new Event('change', { bubbles: true });
                        input.dispatchEvent(event);
                    }
                }
            }
        }
        
        // =========================================================
        //   FUNCIONES PBLICAS (accesibles desde otros scripts)
        // =========================================================
        window.MotoManager = {
            obtenerDatosMoto: function() {
                return currentMotoData;
            },
            tieneMotoRegistrada: function() {
                return currentMotoData !== null;
            },
            recargarDatos: function() {
                return verificarYMostrarMotoRegistrada();
            }
        };
        
        console.log('Script de gesti贸n de motos cargado correctamente');
        
    </script>
</div>